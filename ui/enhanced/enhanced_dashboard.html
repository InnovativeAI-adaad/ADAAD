<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAAD Live Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header .subtitle { color: #94a3b8; font-size: 1.1rem; }
        .status-bar { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .status-card {
            flex: 1; min-width: 250px; background: rgba(51, 65, 85, 0.6);
            border-radius: 12px; padding: 20px; border: 2px solid transparent; transition: all 0.3s ease;
        }
        .status-card:hover {
            border-color: #60a5fa; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(96, 165, 250, 0.2);
        }
        .status-card.active { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .status-card.warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .status-card.error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .status-card h3 {
            font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .status-card .value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .status-card .subvalue { font-size: 0.9rem; color: #64748b; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-bottom: 30px;
        }
        .panel {
            background: rgba(51, 65, 85, 0.6); border-radius: 12px; padding: 25px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .panel h2 {
            font-size: 1.5rem; margin-bottom: 20px; color: #f1f5f9; display: flex; align-items: center; gap: 10px;
        }
        .panel-icon { width: 24px; height: 24px; display: inline-block; }
        .activity-stream { max-height: 400px; overflow-y: auto; }
        .activity-stream::-webkit-scrollbar { width: 8px; }
        .activity-stream::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); border-radius: 4px; }
        .activity-stream::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .activity-item {
            padding: 15px; margin-bottom: 10px; background: rgba(15, 23, 42, 0.5);
            border-radius: 8px; border-left: 3px solid #60a5fa; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .activity-item.governance { border-left-color: #a78bfa; }
        .activity-item.mutation { border-left-color: #10b981; }
        .activity-item.error { border-left-color: #ef4444; }
        .activity-item .timestamp { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        .activity-item .message { color: #e2e8f0; line-height: 1.5; }
        .activity-item .details { margin-top: 8px; font-size: 0.85rem; color: #94a3b8; font-family: 'Courier New', monospace; }
        .mutation-card {
            background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 15px; margin-bottom: 15px;
            border: 1px solid rgba(148, 163, 184, 0.1); transition: all 0.2s ease;
        }
        .mutation-card:hover { border-color: #60a5fa; transform: translateX(5px); }
        .mutation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .mutation-title { font-weight: 600; color: #f1f5f9; }
        .mutation-status { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .mutation-status.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .mutation-meta { font-size: 0.85rem; color: #94a3b8; display: flex; gap: 15px; flex-wrap: wrap; }
        .governance-flow { display: flex; align-items: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .flow-step {
            flex: 1; min-width: 100px; padding: 15px; background: rgba(15, 23, 42, 0.5);
            border-radius: 8px; text-align: center; border: 2px solid transparent; transition: all 0.3s ease;
        }
        .flow-step.completed { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .flow-step.active { border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .flow-step.pending { opacity: 0.5; }
        .flow-arrow { color: #475569; font-size: 1.5rem; }
        .empty-state { text-align: center; padding: 40px; color: #64748b; }
        .live-indicator {
            display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1); border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .live-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .connection-error {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;
        }
        .connection-error.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ ADAAD Live Dashboard</h1>
            <p class="subtitle">Autonomous Development with Accountable Architecture</p>
            <div class="live-indicator" id="liveIndicator">
                <span class="live-dot"></span>
                <span>Live Updates Active</span>
            </div>
        </div>

        <div class="connection-error" id="connectionError">‚ö†Ô∏è Connection to ADAAD lost. Retrying...</div>

        <div class="status-bar">
            <div class="status-card" id="statusCard"><h3>System Status</h3><div class="value" id="systemStatus">Initializing...</div><div class="subvalue">Orchestrator state</div></div>
            <div class="status-card" id="mutationCard"><h3>Mutation Cycle</h3><div class="value" id="mutationStatus">‚Äî</div><div class="subvalue">Current activity</div></div>
            <div class="status-card" id="replayCard"><h3>Replay Mode</h3><div class="value" id="replayMode">‚Äî</div><div class="subvalue">Verification status</div></div>
            <div class="status-card" id="determinismCard"><h3>Determinism Score</h3><div class="value" id="determinismScore">‚Äî</div><div class="subvalue" id="determinismSample">No samples yet</div></div>
        </div>

        <div class="grid">
            <div class="panel">
                <h2><span class="panel-icon">üîÑ</span>Live Activity Stream</h2>
                <div class="activity-stream" id="activityStream"><div class="empty-state">Waiting for ADAAD activity...</div></div>
            </div>
            <div class="panel">
                <h2><span class="panel-icon">‚öñÔ∏è</span>Governance Pipeline</h2>
                <div class="governance-flow">
                    <div class="flow-step" id="step1"><div style="font-size: 1.5rem; margin-bottom: 5px;">üîç</div><div style="font-size: 0.9rem;">Discovery</div></div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step" id="step2"><div style="font-size: 1.5rem; margin-bottom: 5px;">üìä</div><div style="font-size: 0.9rem;">Scoring</div></div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step" id="step3"><div style="font-size: 1.5rem; margin-bottom: 5px;">üõ°Ô∏è</div><div style="font-size: 0.9rem;">Constitution</div></div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step" id="step4"><div style="font-size: 1.5rem; margin-bottom: 5px;">‚úÖ</div><div style="font-size: 0.9rem;">Execution</div></div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 10px;">Current Stage:</div>
                    <div style="font-size: 1.1rem; color: #f1f5f9;" id="currentStage">System initializing...</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="panel"><h2><span class="panel-icon">üß¨</span>Active Mutations</h2><div id="mutationsPanel"><div class="empty-state">No active mutations</div></div></div>
            <div class="panel"><h2><span class="panel-icon">üìã</span>Lineage Journal</h2><div class="activity-stream" id="lineageStream" style="max-height: 300px;"><div class="empty-state">Loading lineage events...</div></div></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let updateInterval;
        let ws = null;
        let lastActivityCount = 0;

        async function updateDashboard() {
            try {
                const [state, metrics, lineage, mutations] = await Promise.all([
                    fetch(`${API_BASE}/state`, { cache: 'no-store' }).then(r => r.json()),
                    fetch(`${API_BASE}/metrics`, { cache: 'no-store' }).then(r => r.json()),
                    fetch(`${API_BASE}/lineage`, { cache: 'no-store' }).then(r => r.json()),
                    fetch(`${API_BASE}/mutations`, { cache: 'no-store' }).then(r => r.json())
                ]);

                document.getElementById('connectionError').classList.remove('show');
                updateSystemStatus(state);
                updateActivityStream(metrics.entries);
                updateLineageStream(lineage);
                updateMutations(mutations);
            } catch (error) {
                console.error('Dashboard update failed:', error);
                document.getElementById('connectionError').classList.add('show');
            }
        }

        function updateSystemStatus(state) {
            const statusCard = document.getElementById('statusCard');
            const statusValue = document.getElementById('systemStatus');
            statusValue.textContent = state.status || 'Unknown';
            statusCard.classList.remove('active', 'warning', 'error');
            if (state.status === 'running') statusCard.classList.add('active');
            else if (state.status === 'error') statusCard.classList.add('error');

            const mutationValue = document.getElementById('mutationStatus');
            const mutationCard = document.getElementById('mutationCard');
            mutationCard.classList.remove('active', 'warning', 'error');
            if (state.mutation_enabled) { mutationValue.textContent = 'Enabled'; mutationCard.classList.add('active'); }
            else { mutationValue.textContent = 'Disabled'; }

            document.getElementById('replayMode').textContent = state.replay_mode || 'Off';

            if (state.determinism_panel) {
                const det = state.determinism_panel;
                const score = (det.rolling_score * 100).toFixed(1);
                document.getElementById('determinismScore').textContent = `${score}%`;
                document.getElementById('determinismSample').textContent = `${det.passed}/${det.sample_size} passed`;

                const detCard = document.getElementById('determinismCard');
                detCard.classList.remove('active', 'warning', 'error');
                if (det.rolling_score >= 0.95) detCard.classList.add('active');
                else if (det.rolling_score >= 0.80) detCard.classList.add('warning');
                else detCard.classList.add('error');
            }
        }

        function updateActivityStream(entries) {
            if (!entries || entries.length === 0) return;
            const stream = document.getElementById('activityStream');
            const newEntries = entries.slice(lastActivityCount);
            if (newEntries.length === 0) return;
            lastActivityCount = entries.length;
            if (stream.querySelector('.empty-state')) stream.innerHTML = '';

            newEntries.reverse().forEach(entry => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                if (entry.event && entry.event.includes('governance')) item.classList.add('governance');
                else if (entry.event && entry.event.includes('mutation')) item.classList.add('mutation');
                else if (entry.level === 'ERROR') item.classList.add('error');

                const ts = entry.timestamp || entry.ts || Date.now();
                const timestamp = new Date(ts).toLocaleTimeString();
                const eventType = entry.event || entry.event_type || 'system';
                const message = entry.message || JSON.stringify(entry.payload || {});

                item.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div class="message"><strong>${eventType}</strong>: ${message}</div>
                    ${entry.element_id ? `<div class="details">Element: ${entry.element_id}</div>` : ''}
                `;
                stream.insertBefore(item, stream.firstChild);
            });

            while (stream.children.length > 50) stream.removeChild(stream.lastChild);
            updateGovernanceFlow(entries[entries.length - 1]);
        }

        function updateGovernanceFlow(lastEntry) {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach((id) => {
                const el = document.getElementById(id);
                el.classList.remove('completed', 'active', 'pending');
                el.classList.add('pending');
            });

            const eventName = String(lastEntry?.event || '').toLowerCase();
            let active = 1;
            if (eventName.includes('fitness') || eventName.includes('score')) active = 2;
            else if (eventName.includes('constitution')) active = 3;
            else if (eventName.includes('mutation') || eventName.includes('executor')) active = 4;

            for (let i = 1; i < active; i++) {
                const e = document.getElementById(`step${i}`);
                e.classList.remove('pending');
                e.classList.add('completed');
            }
            const current = document.getElementById(`step${active}`);
            current.classList.remove('pending');
            current.classList.add('active');

            const labels = {1: 'Discovery', 2: 'Scoring', 3: 'Constitution', 4: 'Execution'};
            document.getElementById('currentStage').textContent = labels[active];
        }

        function updateLineageStream(entries) {
            if (!entries || entries.length === 0) return;
            const stream = document.getElementById('lineageStream');
            stream.innerHTML = '';
            entries.slice(-20).reverse().forEach(entry => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                const timestamp = new Date(entry.timestamp || entry.ts || Date.now()).toLocaleTimeString();
                const eventType = entry.event_type || entry.type || entry.event || 'event';
                item.innerHTML = `
                    <div class="timestamp">${timestamp}</div>
                    <div class="message">${eventType}</div>
                    <div class="details">${JSON.stringify(entry, null, 2).substring(0, 200)}...</div>
                `;
                stream.appendChild(item);
            });
        }


        function startRealtimeUpdates() {
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsScheme}://${window.location.hostname}:8080/ws`;
            try {
                ws = new WebSocket(wsUrl);
                ws.onmessage = () => { updateDashboard(); };
                ws.onerror = () => {
                    if (!updateInterval) {
                        updateInterval = setInterval(updateDashboard, 2000);
                    }
                };
                ws.onclose = () => {
                    if (!updateInterval) {
                        updateInterval = setInterval(updateDashboard, 2000);
                    }
                };
            } catch (_err) {
                if (!updateInterval) {
                    updateInterval = setInterval(updateDashboard, 2000);
                }
            }
        }

        function updateMutations(mutations) {
            const panel = document.getElementById('mutationsPanel');
            if (!mutations || mutations.length === 0) {
                panel.innerHTML = '<div class="empty-state">No active mutations</div>';
                return;
            }

            panel.innerHTML = '';
            mutations.slice(0, 10).forEach(mutation => {
                const card = document.createElement('div');
                card.className = 'mutation-card';
                card.innerHTML = `
                    <div class="mutation-header">
                        <div class="mutation-title">${mutation}</div>
                        <div class="mutation-status pending">Staged</div>
                    </div>
                    <div class="mutation-meta"><div>üìÅ ${mutation}</div></div>
                `;
                panel.appendChild(card);
            });
        }

        updateDashboard();
        startRealtimeUpdates();
        if (!updateInterval) {
            updateInterval = setInterval(updateDashboard, 2000);
        }
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
            if (ws) ws.close();
        });
    </script>
</body>
</html>
